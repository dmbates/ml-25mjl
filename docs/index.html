<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-99.9.9">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Douglas Bates">
<meta name="dcterms.date" content="2022-07-05">

<title>ml-25m - Downloading and examining the MovieLens 25m data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">ml-25m</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page">Home</a>
  </li>  
  <li class="dropdown-header">
 about.qmd</li>
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#download-and-re-configure-the-data" id="toc-download-and-re-configure-the-data" class="nav-link active" data-scroll-target="#download-and-re-configure-the-data">Download and re-configure the data</a>
  <ul class="collapse">
  <li><a href="#download" id="toc-download" class="nav-link" data-scroll-target="#download">Download</a></li>
  <li><a href="#read-the-csv-file-from-the-archive-and-write-as-arrow" id="toc-read-the-csv-file-from-the-archive-and-write-as-arrow" class="nav-link" data-scroll-target="#read-the-csv-file-from-the-archive-and-write-as-arrow">Read the CSV file from the archive and write as Arrow</a></li>
  <li><a href="#read-the-data-from-the-arrow-file" id="toc-read-the-data-from-the-arrow-file" class="nav-link" data-scroll-target="#read-the-data-from-the-arrow-file">Read the data from the Arrow file</a></li>
  </ul></li>
  <li><a href="#the-adjacency-matrix-of-the-bipartite-graph" id="toc-the-adjacency-matrix-of-the-bipartite-graph" class="nav-link" data-scroll-target="#the-adjacency-matrix-of-the-bipartite-graph">The adjacency matrix of the bipartite graph</a>
  <ul class="collapse">
  <li><a href="#diagonal-blocks-in-a" id="toc-diagonal-blocks-in-a" class="nav-link" data-scroll-target="#diagonal-blocks-in-a">Diagonal blocks in A</a>
  <ul class="collapse">
  <li><a href="#number-of-movies-rated-per-user" id="toc-number-of-movies-rated-per-user" class="nav-link" data-scroll-target="#number-of-movies-rated-per-user">Number of movies rated per user</a></li>
  <li><a href="#number-of-users-who-rated-each-movie" id="toc-number-of-users-who-rated-each-movie" class="nav-link" data-scroll-target="#number-of-users-who-rated-each-movie">Number of users who rated each movie</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#computational-methods" id="toc-computational-methods" class="nav-link" data-scroll-target="#computational-methods">Computational methods</a>
  <ul class="collapse">
  <li><a href="#storage-problems" id="toc-storage-problems" class="nav-link" data-scroll-target="#storage-problems">Storage problems</a></li>
  </ul></li>
  <li><a href="#movie-titles-and-genres" id="toc-movie-titles-and-genres" class="nav-link" data-scroll-target="#movie-titles-and-genres">Movie titles and genres</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Downloading and examining the MovieLens 25m data</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Douglas Bates </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 5, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<div class="hidden">
<p><span class="math display">\[
\newcommand\bbA{{\mathbf{A}}}
\newcommand\bbI{{\mathbf{I}}}
\newcommand\bbL{{\mathbf{L}}}
\newcommand\bbLambda{{\boldsymbol{\Lambda}}}
\]</span></p>
</div>
<p>Load the packages to be used</p>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Arrow         </span><span class="co"># compact, cross-language data tables</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CSV</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataAPI       </span><span class="co"># generics for common data representations</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Dates</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Downloads</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Missings</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">SparseArrays</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">TypedTables</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ZipFile</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<section id="download-and-re-configure-the-data" class="level1">
<h1>Download and re-configure the data</h1>
<p>The data are available as a <code>.zip</code> archive at</p>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ml25murl <span class="op">=</span> <span class="st">"https://files.grouplens.org/datasets/movielens/ml-25m.zip"</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="download" class="level2">
<h2 class="anchored" data-anchor-id="download">Download</h2>
<p>Download the zip file, if necessary.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>zipfile <span class="op">=</span> <span class="fu">last</span>(<span class="fu">splitpath</span>(ml25murl))</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">isfile</span>(zipfile) <span class="op">||</span> <span class="bu">Downloads</span>.<span class="fu">download</span>(ml25murl, zipfile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>true</code></pre>
</div>
</div>
</section>
<section id="read-the-csv-file-from-the-archive-and-write-as-arrow" class="level2">
<h2 class="anchored" data-anchor-id="read-the-csv-file-from-the-archive-and-write-as-arrow">Read the CSV file from the archive and write as Arrow</h2>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isdir</span>(<span class="st">"data"</span>) <span class="op">||</span> <span class="fu">mkdir</span>(<span class="st">"data"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ratingsarrow <span class="op">=</span> <span class="fu">joinpath</span>(<span class="st">"data"</span>, <span class="st">"ratings.arrow"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> !<span class="fu">isfile</span>(ratingsarrow)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    Arrow.<span class="fu">write</span>(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        ratingsarrow,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        CSV.<span class="fu">File</span>(</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">only</span>(</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">filter</span>(f <span class="op">-&gt;</span> <span class="fu">endswith</span>(f.name, <span class="st">"ratings.csv"</span>), ZipFile.<span class="fu">Reader</span>(zipfile).files),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            );</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>            delim <span class="op">=</span> <span class="ch">','</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            header <span class="op">=</span> <span class="fl">1</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            types <span class="op">=</span> [<span class="dt">Int32</span>, <span class="dt">Int32</span>, <span class="dt">Float32</span>, <span class="dt">Int32</span>],</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            pool <span class="op">=</span> [<span class="cn">false</span>, <span class="cn">true</span>, <span class="cn">true</span>, <span class="cn">false</span>],</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        );</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        compress <span class="op">=</span> <span class="op">:</span>lz4,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As the CSV file is being read, the second and third columns, which are <code>movieId</code> and <code>rating</code>, are “pooled” so they will be written as <code>DictEncoded</code> in the arrow file.</p>
</section>
<section id="read-the-data-from-the-arrow-file" class="level2">
<h2 class="anchored" data-anchor-id="read-the-data-from-the-arrow-file">Read the data from the Arrow file</h2>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>tbl <span class="op">=</span> Arrow.<span class="fu">Table</span>(ratingsarrow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Arrow.Table with 25000095 rows, 4 columns, and schema:
 :userId     Int32
 :movieId    Int32
 :rating     Float32
 :timestamp  Int32</code></pre>
</div>
</div>
<p>The schema indicates that <code>movieId</code> and <code>rating</code> are <code>Int32</code> and <code>Float32</code>, respectively but they are stored as <code>DictEncoded</code></p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(tbl.movieId), <span class="fu">typeof</span>(tbl.rating)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>(Arrow.DictEncoded{Int32, Int32, Arrow.Primitive{Int32, Vector{Int32}}}, Arrow.DictEncoded{Float32, Int8, Arrow.Primitive{Float32, Vector{Float32}}})</code></pre>
</div>
</div>
<p>Usually <code>DictEncoding</code> (analogous to the <code>factor</code> type in R) is used to save space. For example, the <code>rating</code> column could be stored as 32-bit floats but there are only 10 distinct values</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(<span class="fu">sort</span>(<span class="fu">unique</span>(tbl.rating)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Float32[0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0]</code></pre>
</div>
</div>
<p>and these are stored as 8-bit integer indices into a table of 10 <code>Float32</code> values.</p>
<p>Having the <code>movieId</code> column dict-encoded is not for saving space but rather to be able to use the indices into the DictEncoding table, called the <code>refarray</code>, as row numbers when constructing a sparse matrix. There are many gaps in the original movie numbers and we want to use a contiguous set of row numbers.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">extrema</span>(tbl.movieId), <span class="fu">length</span>(<span class="fu">unique</span>(tbl.movieId)), <span class="fu">extrema</span>(DataAPI.<span class="fu">refarray</span>(tbl.movieId))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>((1, 209171), 59047, (1, 59047))</code></pre>
</div>
</div>
<p>The <code>timestamp</code> column is in the old-style Unix form of an Int32 representing the number of seconds since the epoch (midnight, January 1, 1970).</p>
<p>These values can be converted to the <code>DateTime</code> type with <code>Dates.unix2datetime</code>.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(<span class="fu">first</span>(<span class="bu">Dates</span>.<span class="fu">unix2datetime</span>.(tbl.timestamp), <span class="fl">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[DateTime</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>("2006-05-17T15:34:04"), DateTime("2006-05-17T12:26:57"), DateTime("2006-05-17T12:27:08")]</code></pre>
</div>
</div>
</section>
</section>
<section id="the-adjacency-matrix-of-the-bipartite-graph" class="level1">
<h1>The adjacency matrix of the bipartite graph</h1>
<p>A cross-tabulation of users and movies they have rated can be considered as the <a href="https://en.wikipedia.org/wiki/Adjacency_matrix">adjacency matrix</a> of a <a href="https://en.wikipedia.org/wiki/Bipartite_graph">bipartite graph</a>. If a user rates a movie there is an edge in the graph between the user and the movie. All edges are between a user and a movie which is what makes the graph bipartitie (two separate groups of vertices and the only edges are between the groups).</p>
<p>Whether that is particularly helpful in the cases I am considering I don’t know.</p>
<p>I will call this adjacency matrix <code>A21</code> as it is in the [2,1] position of a matrix we usually call <code>A</code> (we’re quite creative about naming things).</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>A21 <span class="op">=</span> <span class="fu">sparse</span>(DataAPI.<span class="fu">refarray</span>(tbl.movieId), tbl.userId, <span class="cn">true</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>59047×162541 SparseMatrixCSC{Bool, Int32} with 25000095 stored entries:
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⠈⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⠀⠀⠈⠻⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⠀⠀⠀⠀⠀⠉⠛⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠙⠛⠛⠻⠿⠿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⠛⠿⠿⠿⠿⠿⠿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠉⠉⠉⠉</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="fu">summarysize</span>(A21) <span class="op">/</span> (<span class="fl">2</span><span class="op">^</span><span class="fl">20</span>)   <span class="co"># total size of the sparse matrix in MB</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>119.82994365692139</code></pre>
</div>
</div>
<p>Although the display of the matrix appears to be nearly dense, it is, in fact, quite sparse</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nnz</span>(A21) <span class="op">/</span> <span class="fu">length</span>(A21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>0.002604839052572928</code></pre>
</div>
</div>
<section id="diagonal-blocks-in-a" class="level2">
<h2 class="anchored" data-anchor-id="diagonal-blocks-in-a">Diagonal blocks in A</h2>
<p>There are two other non-redundant blocks in <code>A</code>, both of which are diagonal. The diagonal of <code>A11</code> is simply the number of movies each user has rated and the diagonal of <code>A22</code> is the number of ratings for each movie.</p>
<section id="number-of-movies-rated-per-user" class="level3">
<h3 class="anchored" data-anchor-id="number-of-movies-rated-per-user">Number of movies rated per user</h3>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>A11diag <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Int32</span>.(<span class="fu">sum</span>(A21; dims<span class="op">=</span><span class="fl">1</span>)))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>A11diag<span class="op">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>1×162541 adjoint(::Vector{Int32}) with eltype Int32:
 70  184  656  242  101  26  25  155  …  487  65  79  101  154  47  88  182</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">extrema</span>(A11diag), <span class="fu">sum</span>(<span class="fu">≤</span>(<span class="fl">100</span>), A11diag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>((20, 32202), 99439)</code></pre>
</div>
</div>
<p>Apparently someone rated over 32,000 movies; one hopes they are or were a professional movie critic. Nearly 100,000 of the 162,000 users represented here rated between 20 and 100 movies.</p>
</section>
<section id="number-of-users-who-rated-each-movie" class="level3">
<h3 class="anchored" data-anchor-id="number-of-users-who-rated-each-movie">Number of users who rated each movie</h3>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>A22diag <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Int32</span>.(<span class="fu">sum</span>(A21; dims<span class="op">=</span><span class="fl">2</span>)))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>A22diag<span class="op">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>1×59047 adjoint(::Vector{Int32}) with eltype Int32:
 79672  7058  6616  1269  10895  11935  …  1  1  1  1  1  1  1  1  1  1  1  1</code></pre>
</div>
</div>
<p>Notice that there are many movies that have only a single rating in this subset of the overall ratings data.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">extrema</span>(A22diag), <span class="fu">sum</span>(isone, A22diag), <span class="fu">sum</span>(<span class="fu">&lt;</span>(<span class="fl">4</span>), A22diag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>((1, 81491), 10298, 22854)</code></pre>
</div>
</div>
<p>That is, over 1/6 of these 59,047 movies have only one rating and over 1/3 have fewer than 4 ratings.</p>
<p>With so little information these movies will not affect parameter estimates for models but they will cost us dearly in terms of the amount of storage required, which in the methods described below is quadratic in the number of movies. Reducing the number of movies by 1/3 cuts the amount of storage to 4/9 of the original amount.</p>
</section>
</section>
</section>
<section id="computational-methods" class="level1">
<h1>Computational methods</h1>
<p>I wish to obtain the Cholesky factor of the symmetric blocked matrix, <span class="math inline">\(\bbLambda'\bbA\bbLambda + \bbI\)</span>, where</p>
<p><span id="eq-Adef"><span class="math display">\[
\bbA = \begin{bmatrix}
\bbA_{1,1} &amp; \bbA_{2,1}^\prime \\
\bbA_{2,1} &amp; \bbA_{2,2}
\end{bmatrix}
\tag{1}\]</span></span></p>
<p>and <span class="math inline">\(\bbLambda\)</span> is diagonal with non-negative diagonal elements. (In other cases <span class="math inline">\(\bbLambda\)</span> can be block-diagonal with small triangular blocks, which is why the formula includes the transpose.)</p>
<p>In fact, in this case <span class="math inline">\(\bbLambda\)</span> consists of two non-negative multiples of identity matrices, the first the same size as <span class="math inline">\(\bbA_{1,1}\)</span> and the second the same size as <span class="math inline">\(\bbA_{2,2}\)</span>. To experiment with computational methods you can just set <span class="math inline">\(\bbLambda = \bbI\)</span>.</p>
<p>Suppose we write the lower-triangular Cholesky factor as</p>
<p><span id="eq-Adef"><span class="math display">\[
\bbL = \begin{bmatrix}
\bbL_{1,1} &amp; \mathbf{0} \\
\bbL_{2,1} &amp; \bbL_{2,2}
\end{bmatrix}
\tag{2}\]</span></span></p>
<p>Then <span class="math inline">\(\bbL_{1,1}\)</span> and <span class="math inline">\(\bbL_{2,1}\)</span> have the same non-zero patterns as <span class="math inline">\(\bbA_{1,1}\)</span> and <span class="math inline">\(\bbA_{2,1}\)</span> but <span class="math inline">\(\bbL_{2,2}\)</span> will, in general, experience fill-in. I haven’t checked but I expect that <span class="math inline">\(\bbL_{2,2}\)</span> will have nearly complete fill-in in this case, even after a fill-reducing permutation. At least I expect that there will be sufficient fill-in that it will be easiest to store it as a dense triangular matrix.</p>
<section id="storage-problems" class="level2">
<h2 class="anchored" data-anchor-id="storage-problems">Storage problems</h2>
<p>My problem is that I don’t have enough memory/swap space to store such a dense matrix.</p>
<p>As an <code>Array{Float64, 2}</code> it would require nearly 26 GB.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">abs2</span>(<span class="fu">length</span>(A22diag)) <span class="op">*</span> <span class="fl">8</span> <span class="op">/</span> (<span class="fl">2</span><span class="op">^</span><span class="fl">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>25.976808436214924</code></pre>
</div>
</div>
<p>Various options I have considered are:</p>
<ul>
<li><p>Get access to a computer with more memory.</p></li>
<li><p>Use <code>Float32</code> instead of <code>Float64</code></p></li>
<li><p>Use <code>mmap</code> arrays</p></li>
<li><p>Use a packed symmetric storage, probably <a href="https://link.springer.com/chapter/10.1007/978-3-540-75755-9_69">rectangular full packed</a></p></li>
<li><p>Trim the movies with fewer than 4 ratings</p></li>
<li><p>Some combination of the above</p></li>
</ul>
<p>Suggestions?</p>
</section>
</section>
<section id="movie-titles-and-genres" class="level1">
<h1>Movie titles and genres</h1>
<p>Create a single table containing the information on each movie, including the movie numbers in the <code>imdb.com</code> and <code>themoviedb.org</code> (tmdb) databases.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>moviesarrow <span class="op">=</span> <span class="fu">joinpath</span>(<span class="st">"data"</span>, <span class="st">"movies.arrow"</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> !<span class="fu">isfile</span>(moviesarrow)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    movies <span class="op">=</span> CSV.<span class="fu">read</span>(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">only</span>(<span class="fu">filter</span>(f <span class="op">-&gt;</span> <span class="fu">endswith</span>(f.name, <span class="st">"movies.csv"</span>), ZipFile.<span class="fu">Reader</span>(zipfile).files)),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        DataFrame;</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        types<span class="op">=</span>[<span class="dt">Int32</span>, <span class="dt">String</span>, <span class="dt">String</span>],</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        pool<span class="op">=</span>[<span class="cn">false</span>, <span class="cn">false</span>, <span class="cn">true</span>]</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">replace!</span>(movies.genres, <span class="st">"(no genres listed)"</span> <span class="op">=&gt;</span> <span class="st">""</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="dt">String</span>[]</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    year <span class="op">=</span> <span class="dt">Union</span>{<span class="dt">Missing</span>,<span class="dt">Int16</span>}[]</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    yearregex <span class="op">=</span> <span class="st">r"</span><span class="ch">(</span><span class="sc">.*</span><span class="ch">)</span><span class="sc">\(</span><span class="ch">(</span><span class="sc">\d+</span><span class="ch">)</span><span class="sc">\)+\s*$</span><span class="st">"</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="st">    </span>for<span class="st"> t in movies</span><span class="sc">.</span><span class="st">title</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> <span class="fu">match</span>(yearregex, t)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">isnothing</span>(m)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">push!</span>(title, <span class="fu">strip</span>(t))</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">push!</span>(year, <span class="cn">missing</span>)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">push!</span>(title, <span class="fu">strip</span>(<span class="fu">first</span>(m.captures)))</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">push!</span>(year, <span class="fu">parse</span>(<span class="dt">Int16</span>, <span class="fu">last</span>(m.captures)))</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    movies.title <span class="op">=</span> title</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    movies.year <span class="op">=</span> year</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">disallowmissing!</span>(</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">leftjoin!</span>(</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>            movies,</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>            CSV.<span class="fu">read</span>(</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>                <span class="fu">only</span>(<span class="fu">filter</span>(f <span class="op">-&gt;</span> <span class="fu">endswith</span>(f.name, <span class="st">"links.csv"</span>), ZipFile.<span class="fu">Reader</span>(zipfile).files)),</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>                DataFrame;</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>                types<span class="op">=</span>[<span class="dt">Int32</span>,<span class="dt">Int32</span>,<span class="dt">Int32</span>]</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>            );</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=:</span>movieId</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>        );</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>        error<span class="op">=</span><span class="cn">false</span>,</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select!</span>(movies, <span class="op">:</span>title, <span class="op">:</span>year, <span class="op">:</span>genres, <span class="op">:</span>tmdbId, <span class="op">:</span>imdbId, <span class="op">:</span>movieId)</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    Arrow.<span class="fu">write</span>(moviesarrow, movies; compress<span class="op">=:</span>lz4)</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Table</span>(movies)</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>Table with 6 columns and 62423 rows:
      title                 year  genres                tmdbId  imdbId  movieId
    ┌──────────────────────────────────────────────────────────────────────────
 1  │ Toy Story             1995  Adventure|Animation…  862     114709  1
 2  │ Jumanji               1995  Adventure|Children|…  8844    113497  2
 3  │ Grumpier Old Men      1995  Comedy|Romance        15602   113228  3
 4  │ Waiting to Exhale     1995  Comedy|Drama|Romance  31357   114885  4
 5  │ Father of the Bride…  1995  Comedy                11862   113041  5
 6  │ Heat                  1995  Action|Crime|Thrill…  949     113277  6
 7  │ Sabrina               1995  Comedy|Romance        11860   114319  7
 8  │ Tom and Huck          1995  Adventure|Children    45325   112302  8
 9  │ Sudden Death          1995  Action                9091    114576  9
 10 │ GoldenEye             1995  Action|Adventure|Th…  710     113189  10
 11 │ American President,…  1995  Comedy|Drama|Romance  9087    112346  11
 12 │ Dracula: Dead and L…  1995  Comedy|Horror         12110   112896  12
 13 │ Balto                 1995  Adventure|Animation…  21032   112453  13
 14 │ Nixon                 1995  Drama                 10858   113987  14
 15 │ Cutthroat Island      1995  Action|Adventure|Ro…  1408    112760  15
 16 │ Casino                1995  Crime|Drama           524     112641  16
 17 │ Sense and Sensibili…  1995  Drama|Romance         4584    114388  17
 18 │ Four Rooms            1995  Comedy                5       113101  18
 19 │ Ace Ventura: When N…  1995  Comedy                9273    112281  19
 20 │ Money Train           1995  Action|Comedy|Crime…  11517   113845  20
 21 │ Get Shorty            1995  Comedy|Crime|Thrill…  8012    113161  21
 22 │ Copycat               1995  Crime|Drama|Horror|…  1710    112722  22
 23 │ Assassins             1995  Action|Crime|Thrill…  9691    112401  23
 ⋮  │          ⋮             ⋮             ⋮              ⋮       ⋮        ⋮</code></pre>
</div>
</div>
<p>More information on individual movies can be retrieved from <code>https://themoviedb.org/movie/&lt;tmdbId&gt;</code></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>